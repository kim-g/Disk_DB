unit HistoryUnit;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.Grids, Vcl.DBGrids, Data.DB,
  Data.Win.ADODB, Vcl.ExtCtrls, Vcl.StdCtrls;

type
  THistory = class(TForm)
    Panel1: TPanel;
    Panel2: TPanel;
    Query: TADOQuery;
    DBGrid1: TDBGrid;
    DataSource: TDataSource;
    Edit1: TEdit;
    Label1: TLabel;
    Label2: TLabel;
    CB: TComboBox;
    procedure ShowHistory;
    procedure Scale;
    procedure Edit1Change(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
  private
    procedure GetData;
  public
    { Public declarations }
  end;

var
  History: THistory;
  CBS:TStringList;

implementation

{$R *.dfm}

uses MenuUnit;

{ THistory }

procedure THistory.Edit1Change(Sender: TObject);
begin
GetData;
end;

procedure THistory.FormCreate(Sender: TObject);
begin
CBS:=TStringList.Create;
end;

procedure THistory.FormDestroy(Sender: TObject);
begin
CBS.Free;
end;

procedure THistory.GetData;
begin
Query.Active:=false;

with Query.SQL do
  begin
  Clear;
  Add('SELECT Hist.Код_Операции, Hist.Фамилия, Hist.GOT, Список_Дисков.[Номер в каталоге], История.дата');
  Add('FROM Список_Дисков');
  Add('  INNER JOIN');
  Add('');
  Add('    (SELECT История.Код_Операции, [Члены труппы].[Табельный номер] AS TN, [Члены труппы].Фамилия, [Операции]![Операция] & [ТаблицаПолА]![Значение] AS GOT, История.дата, История.диск');
  Add('     FROM ТаблицаПолА');
  Add('       INNER JOIN (Операции');
  Add('         INNER JOIN ([Члены труппы]');
  Add('           INNER JOIN История');
  Add('           ON [Члены труппы].[Табельный номер] = История.Член_Труппы)');
  Add('         ON Операции.Код_Операции = История.Операция)');
  Add('       ON ТаблицаПолА.Код = [Члены труппы].Пол) AS Hist');
  Add('');
  Add('  ON Список_Дисков.ID_Диска = Hist.диск');
  end;

if (Edit1.Text<>'') AND (CBS[CB.ItemIndex]='ALL') then Query.SQL.Add('WHERE Список_Дисков.[Номер в каталоге] = '+ Edit1.Text);
if (Edit1.Text<>'') AND (CBS[CB.ItemIndex]<>'ALL') then Query.SQL.Add('WHERE (Список_Дисков.[Номер в каталоге] = '+ Edit1.Text + ')' +
                                                                      'AND (Hist.TN = )' + CBS[CB.ItemIndex]);
if (Edit1.Text='') AND (CBS[CB.ItemIndex]<>'ALL') then Query.SQL.Add('WHERE (Hist.TN = )' + CBS[CB.ItemIndex]);


Query.SQL.Add('ORDER BY История.Код_Операции;');

Query.Active:=true;
Scale;
end;

procedure THistory.Scale;
var
  I: Integer;
const
  NRow = 5;
  GridColNames: array [0..NRow-1] of string = ('','Член труппы','Операция','Диск','Дата');
  GridColWith: array [0..NRow-1] of integer = (0,200,140,80,200);
begin
for I := 0 to NRow-1 do
  begin
  DBGrid1.Columns[i].Title.Caption:=GridColNames[i];   // Изменение заголовков
  DBGrid1.Columns[i].Width:=GridColWith[i];            // и размеров.
  DBGrid1.Columns[i].ReadOnly:=true;                   // запрещаем изменять значения для всех.
  end;
end;

procedure THistory.ShowHistory;
begin
Query.Active:=false;

with Query.SQL do
  begin
  Clear;
  Add('SELECT * FROM [Члены труппы] WHERE (Действующий = TRUE) AND ([Табельный номер] > -1)');
  end;

Query.Open;

CB.Items.Clear;
CBS.Clear;

CB.Items.Add('-- ВСЕ --');
CBS.Add('ALL');
while not Query.Eof do
    begin
    CB.Items.Add(Query.FieldByName('Фамилия').AsString + ' ' + Query.FieldByName('Имя').AsString);
    CBS.Add(Query.FieldByName('Табельный номер').AsString);
    Query.next;
    end;
  Query.Close;
CB.ItemIndex:=0;
GetData;
ShowModal;
end;

end.
