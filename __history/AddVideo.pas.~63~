unit AddVideo;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Data.DB, Data.Win.ADODB, Vcl.StdCtrls,
  Vcl.ExtCtrls, Vcl.ComCtrls;

type
  TAddVideoForm = class(TForm)
    Query: TADOQuery;
    List: TListBox;
    LabelPanel: TPanel;
    Kat: TComboBox;
    Label1: TLabel;
    Label2: TLabel;
    Num: TEdit;
    Label3: TLabel;
    DT: TDateTimePicker;
    Label4: TLabel;
    Place: TComboBox;
    Button3: TButton;
    Bevel1: TBevel;
    Button2: TButton;
    Button1: TButton;
    DCheck: TCheckBox;

    function AddDisk_AddVideo:boolean;
    procedure FormCreate(Sender: TObject);
    procedure KatChange(Sender: TObject);
    procedure Button3Click(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
  private
    procedure UpdateTable;
    procedure Prepare;
    procedure UpdateTableEvent(Sender: TObject);
  public
    { Public declarations }
  end;

var
  AddVideoForm: TAddVideoForm;
  Cont:boolean;
  ID, ID_Kat, ID_Place:TStringList;

implementation

{$R *.dfm}

uses MenuUnit;

{ TAddVideoForm }

function TAddVideoForm.AddDisk_AddVideo: boolean;
var
  S:string;
begin
Cont:=false;
LabelPanel.Caption:=NewDisk.Title_Text;
Prepare;
UpdateTable;
ShowModal;
AddDisk_AddVideo:=Cont;
end;

procedure TAddVideoForm.Button1Click(Sender: TObject);
var
  SysDate:TSystemTime;
  n:integer;
  s:string;
begin
with Query do
  begin
  SQL.Clear;
  SQL.Add('SELECT Count(*) AS Число');
  SQL.Add('FROM Видеозаписи ');
  SQL.Add('WHERE (Видеозаписи.Сюжет = ' + IntToStr(NewDisk.Title) + ')');
  SQL.Add(' AND (Видеозаписи.Категория = ' + ID_Kat[Kat.ItemIndex] + ')');
  if Num.Text<> '' then SQL.Add(' AND (Видеозаписи.Номер_Спектакля = ' + Num.Text + ')');
  DateTimeToSystemTime(DT.Date,SysDate);
  if DCheck.Checked then
    SQL.Add(' AND (Видеозаписи.Дата_Спектакля = #' + IntToStr(SysDate.wMonth) + '/' +
      IntToStr(SysDate.wDay) + '/' + IntToStr(SysDate.wYear) + '#)');
  SQL.Add(' AND (Видеозаписи.Место_на_полке = ' + ID_Place[Place.ItemIndex] + ');');
  SQL_History.AddList(SQL);
  Open;
  n:=FieldByName('Число').AsInteger;
  Close;
  if n=0 then
    begin
    SQL.Clear;
    SQL.Add('INSERT INTO Видеозаписи');
    s:='(Сюжет, Категория, Номер_Спектакля, ';
    if DCheck.Checked then s:=s+'Дата_Спектакля, ';
    s:=s+'Место_на_полке)';
    SQL.Add(s);
    s:='VALUES (' + IntToStr(NewDisk.Title) + ', ' + ID_Kat[Kat.ItemIndex] + ', ';
    if Num.Text='' then s:=s+'NULL, ' else s:=s+Num.Text + ', ';

    if DCheck.Checked then s := s + '#' + IntToStr(SysDate.wMonth) + '/' +
        IntToStr(SysDate.wDay) + '/' + IntToStr(SysDate.wYear) + '#, ';
    s:= s + ID_Place[Place.ItemIndex] + ');';
    SQL.Add(s);
    SQL_History.AddList(SQL);

    ExecSQL;
    UpdateTable;
    end;
  end;
end;

procedure TAddVideoForm.Button2Click(Sender: TObject);
begin
if List.ItemIndex=-1 then
  begin
  ShowMessage('Выберите видеозапись!');
  exit;
  end;

NewDisk.Video:=ID[List.ItemIndex];
end;

procedure TAddVideoForm.Button3Click(Sender: TObject);
begin
Close;
end;

procedure TAddVideoForm.FormCreate(Sender: TObject);
begin
ID:=TStringList.Create;
ID_Kat:=TStringList.Create;
ID_Place:=TStringList.Create;
end;

procedure TAddVideoForm.KatChange(Sender: TObject);
begin
UpdateTable;
end;

procedure TAddVideoForm.Prepare;
begin
Kat.Items.Clear;
ID_Kat.Clear;
Kat.Items.Add('-- ВСЕ --');
ID_Kat.Add('-1');

with Query do
  begin
  SQL.Clear;
  SQL.Add('SELECT ID, Категория');
  SQL.Add('FROM Категории');
  SQL.Add('ORDER BY ID;');

  Open;

  while not Eof do
      begin
        Kat.Items.Add(FieldByName('Категория').AsString);
        ID_Kat.Add(FieldByName('ID').AsString);
        next;
      end;
    close;
  end;

Kat.ItemIndex:=0;

Place.Items.Clear;
ID_Place.Clear;
Kat.Items.Add('-- Выбрать --');
ID_Kat.Add('-1');

with Query do
  begin
  SQL.Clear;
  SQL.Add('SELECT ID, [Место на полке]');
  SQL.Add('FROM МестоНаПолке');
  SQL.Add('ORDER BY ID;');

  Open;

  while not Eof do
      begin
        Place.Items.Add(FieldByName('Место на полке').AsString);
        ID_Place.Add(FieldByName('ID').AsString);
        next;
      end;
    close;
  end;

Place.ItemIndex:=0;

end;

procedure TAddVideoForm.UpdateTable;
var
  s:string;
begin
List.Items.Clear;
ID.Clear;

with Query do
  begin
  SQL.Clear;
  SQL.Add('SELECT Видеозаписи.ID_Видеозаписи, Категории.Категория, Сюжеты.Название, Видеозаписи.Номер_Спектакля,');
  SQL.Add(' Видеозаписи.Дата_Спектакля, МестоНаПолке.[Место на полке]');
  SQL.Add('FROM МестоНаПолке ');
  SQL.Add('INNER JOIN (Категории');
  SQL.Add('  INNER JOIN (Сюжеты');
  SQL.Add('    INNER JOIN Видеозаписи ON Сюжеты.ID_Сюжета = Видеозаписи.Сюжет) ');
  SQL.Add('  ON Категории.ID = Видеозаписи.Категория) ');
  SQL.Add('ON МестоНаПолке.ID = Видеозаписи.Место_на_полке');
  SQL.Add('WHERE (Видеозаписи.Сюжет = ' + IntToStr(NewDisk.Title) + ')');
  if Kat.ItemIndex<>0 then SQL.Add(' AND (Видеозаписи.Категория = ' + ID_Kat[Kat.ItemIndex] + ')');
  if Num.Text<>'' then SQL.Add(' AND (Видеозаписи.Номер_Спектакля = ' + Num.Text + ')');
  SQL.Add('ORDER BY Видеозаписи.Категория, Видеозаписи.Номер_Спектакля');

  Open;

  while not Eof do
      begin
        s:=FieldByName('Категория').AsString + ' «' +
                       FieldByName('Название').AsString + '» ';
        if FieldByName('Номер_Спектакля').AsString<>'' then
          s:=s + '(' + FieldByName('Номер_Спектакля').AsString + ') ';
        if FieldByName('Дата_Спектакля').AsString<>'' then
          s:=s + DateToStr(FieldByName('Дата_Спектакля').AsDateTime) + ' ';
        s:=s + FieldByName('Место на полке').AsString + ' ';
        List.Items.Add(s);
        ID.Add(FieldByName('ID_Видеозаписи').AsString);
        next;
      end;
    close;
  end;

end;

procedure TAddVideoForm.UpdateTableEvent(Sender: TObject);
begin

end;

end.
